import { expect, test } from "vitest";
import { Version, pack, unpack } from "./protocol";
import { NoCryptShare } from "../crypt";

test("v1", () => {
  const share: NoCryptShare = new NoCryptShare(
    new Uint8Array(Buffer.from('{"total":0,"threshold":0,"content":"VEVTVF9WMV9QQUNLRVRfMTIzNDU2Nzg5MA=="}')),
  );
  const packed = pack(Version.V1, share);

  expect(packed).toEqual(
    new Uint8Array([
      123, 34, 112, 114, 111, 116, 111, 99, 111, 108, 95, 118, 101, 114, 115, 105, 111, 110, 34, 58, 34, 86, 49, 34, 44,
      34, 112, 97, 99, 107, 101, 116, 34, 58, 34, 101, 121, 74, 106, 99, 110, 108, 119, 100, 70, 57, 104, 98, 71, 100,
      118, 99, 109, 108, 48, 97, 71, 48, 105, 79, 105, 74, 79, 84, 49, 57, 68, 85, 108, 108, 81, 86, 67, 73, 115, 73,
      110, 78, 111, 89, 88, 74, 108, 88, 51, 66, 104, 89, 50, 116, 108, 100, 67, 73, 54, 73, 109, 86, 53, 83, 106, 66,
      105, 77, 49, 74, 111, 89, 107, 78, 74, 78, 107, 49, 68, 100, 50, 108, 107, 82, 50, 104, 53, 87, 108, 104, 79, 98,
      50, 73, 121, 101, 71, 116, 74, 97, 109, 57, 51, 84, 69, 78, 75, 97, 109, 73, 121, 78, 84, 66, 97, 86, 122, 85,
      119, 83, 87, 112, 118, 97, 86, 90, 114, 86, 108, 100, 87, 82, 108, 112, 72, 84, 49, 90, 107, 84, 108, 90, 113, 98,
      70, 74, 86, 86, 108, 90, 80, 86, 69, 90, 75, 86, 49, 86, 116, 87, 107, 53, 87, 82, 87, 119, 50, 86, 71, 116, 83,
      86, 107, 49, 114, 78, 84, 90, 97, 101, 108, 90, 79, 85, 86, 81, 119, 79, 85, 108, 117, 77, 68, 48, 105, 102, 81,
      61, 61, 34, 125,
    ]),
  );

  const unpacked = unpack(packed);

  expect(unpacked).toEqual(share);
});
